// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "rhel-openssl-3.0.x"]
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model School {
  id            String         @id @default(uuid())
  name          String
  phone         String?
  email         String?
  website       String?
  academicYears AcademicYear[]
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
}

model AcademicYear {
  id        String     @id @default(uuid())
  year      Int // e.g. 2567
  semesters Semester[]
  schoolId  String
  school    School     @relation(fields: [schoolId], references: [id], onDelete: Cascade)
}

model Semester {
  id             String       @id @default(uuid())
  term           Int // 1 or 2
  academicYearId String
  academicYear   AcademicYear @relation(fields: [academicYearId], references: [id], onDelete: Cascade)
  classrooms     Classroom[]
  subjects       Subject[]
}

model GradeLevel {
  id         String      @id @default(uuid())
  level      String // e.g. "ม.3"
  classrooms Classroom[]
}

model Classroom {
  id                String      @id @default(uuid())
  roomNumber        String // e.g. "2" รวมเป็น "ม.3/2"
  gradeId           String
  semesterId        String
  grade             GradeLevel  @relation(fields: [gradeId], references: [id])
  semester          Semester    @relation(fields: [semesterId], references: [id])
  homeroomTeacherId String?     @unique
  homeroomTeacher   Teacher?    @relation("Homeroom", fields: [homeroomTeacherId], references: [id])
  students          Student[]
  subjects          Subject[]
  assignments       Assignment[]
  schedules         Schedule[]
  qrSessions        QRAttendanceSession[]
  createdAt         DateTime    @default(now())
  updatedAt         DateTime    @updatedAt

  @@index([semesterId])
}

model User {
  id        String   @id @default(uuid())
  email     String   @unique
  password  String
  firstName String
  lastName  String
  role      Role     @default(STUDENT)
  teacher   Teacher?
  student   Student?
  avatarUrl       String?
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
  createdEvents      Event[]              @relation("EventCreator")
  reviewedLeaves     LeaveRequest[]       @relation("LeaveReviewer")
  qrSessions         QRAttendanceSession[] @relation("QRSessionCreator")
  createdSurveys     Survey[]             @relation("SurveyCreator")
  surveyResponses    SurveyResponse[]
}

model Student {
  id              String        @id @default(uuid())
  studentCode     String        @unique
  userId          String        @unique
  user            User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  classroomId     String
  classroom       Classroom     @relation(fields: [classroomId], references: [id], onDelete: Cascade)
  attendance      Attendance[]
  submissions     Submission[]
  behaviorLogs    BehaviorLog[]
  enrolledSubjects StudentSubject[]
  leaveRequests   LeaveRequest[]
  portfolioItems  PortfolioItem[]
  parentLineToken String? // สำหรับแจ้งเตือนผู้ปกครองรายบุคคล
  gpa             Float    @default(0.00)

  @@index([classroomId])
  @@index([gpa])
}

model Teacher {
  id            String     @id @default(uuid())
  userId        String     @unique
  user          User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  homeroomClass Classroom? @relation("Homeroom")
  subjects      Subject[]
  materials     LearningMaterial[]
  schedules     Schedule[]
}

model Subject {
  id          String   @id @default(uuid())
  name        String
  code        String
  teacherId   String
  teacher     Teacher  @relation(fields: [teacherId], references: [id], onDelete: Cascade)
  classroomId String?
  classroom   Classroom? @relation(fields: [classroomId], references: [id], onDelete: SetNull)
  assignments Assignment[]
  materials   LearningMaterial[]
  schedules   Schedule[]
  credit      Float       @default(1.5)
  semesterId  String?
  semester    Semester?   @relation(fields: [semesterId], references: [id])
  students    StudentSubject[]

  @@index([teacherId])
  @@index([classroomId])
  @@index([semesterId])
}

model Assignment {
  id          String       @id @default(uuid())
  title       String
  description String?
  maxPoints   Float
  dueDate     DateTime?
  subjectId   String
  subject     Subject      @relation(fields: [subjectId], references: [id], onDelete: Cascade)
  attachments String[]     @default([])
  submissions Submission[]
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  classroom   Classroom?   @relation(fields: [classroomId], references: [id], onDelete: SetNull)
  classroomId String?      // This matches the AssessmentService implementation
  @@index([subjectId])
  @@index([classroomId])
}

model Submission {
  id           String     @id @default(uuid())
  content      String?
  points       Float?
  feedback     String?
  status       String     @default("PENDING") // PENDING, SUBMITTED, GRADED
  attachments  String[]   @default([])
  studentId    String
  student      Student    @relation(fields: [studentId], references: [id], onDelete: Cascade)
  assignmentId String
  assignment   Assignment @relation(fields: [assignmentId], references: [id], onDelete: Cascade)
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt

  @@unique([studentId, assignmentId]) // Added for bulkUpdateGrades upsert
  @@index([studentId, status])
  @@index([assignmentId])
}

model LearningMaterial {
  id          String    @id @default(uuid())
  title       String
  description String?
  fileUrl     String
  fileType    String?
  subjectId   String
  subject     Subject   @relation(fields: [subjectId], references: [id], onDelete: Cascade)
  teacherId   String
  teacher     Teacher   @relation(fields: [teacherId], references: [id], onDelete: Cascade)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
}

model Attendance {
  id        String           @id @default(uuid())
  date      DateTime         @default(now())
  status    AttendanceStatus
  studentId String
  student   Student          @relation(fields: [studentId], references: [id], onDelete: Cascade)
  period    Int // 1-8
  remarks   String?

  @@index([date])
  @@index([status])
  @@index([period])
  @@index([studentId])
  @@index([studentId, date, period])
  @@unique([studentId, date, period], name: "studentId_date_period")
}

model BehaviorLog {
  id        String   @id @default(uuid())
  type      String // POSITIVE, NEGATIVE
  content   String
  points    Int      @default(0)
  studentId String
  student   Student  @relation(fields: [studentId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())

  @@index([studentId])
  @@index([studentId, type])
  @@index([createdAt])
}

model Notification {
  id        String   @id @default(uuid())
  title     String
  content   String
  type      String // ANNOUNCEMENT, ALERT
  targetId  String? // Classroom ID or null for Global
  imageUrl  String?
  isPinned  Boolean  @default(false)
  expiresAt DateTime?
  creatorId String?
  readBy    UserNotification[]
  createdAt DateTime @default(now())

  @@index([targetId])
  @@index([createdAt])
  @@index([type])
}

model UserNotification {
  id             String       @id @default(uuid())
  userId         String
  notificationId String
  notification   Notification @relation(fields: [notificationId], references: [id], onDelete: Cascade)
  isRead         Boolean      @default(false)
  readAt         DateTime?
  createdAt      DateTime     @default(now())

  @@unique([userId, notificationId])
  @@index([userId])
}

model StudentSubject {
  id        String   @id @default(uuid())
  studentId String
  student   Student  @relation(fields: [studentId], references: [id], onDelete: Cascade)
  subjectId String
  subject   Subject  @relation(fields: [subjectId], references: [id], onDelete: Cascade)
  grade     Float?   // 0 - 4.0
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([studentId, subjectId])
  @@index([studentId])
  @@index([subjectId])
}

model Schedule {
  id          String    @id @default(uuid())
  dayOfWeek   String    // MONDAY, TUESDAY, WEDNESDAY, THURSDAY, FRIDAY
  periodStart Int       // 1-8
  periodEnd   Int       // 1-8
  subjectId   String
  subject     Subject   @relation(fields: [subjectId], references: [id], onDelete: Cascade)
  classroomId String
  classroom   Classroom @relation(fields: [classroomId], references: [id], onDelete: Cascade)
  teacherId   String
  teacher     Teacher   @relation(fields: [teacherId], references: [id], onDelete: Cascade)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@unique([dayOfWeek, periodStart, classroomId])
  @@unique([dayOfWeek, periodStart, teacherId])
  @@index([teacherId])
  @@index([classroomId])
}

enum Role {
  ADMIN
  TEACHER
  STUDENT
}

enum AttendanceStatus {
  PRESENT
  LATE
  ABSENT
  LEAVE
}

// ============================================================
// Event Calendar
// ============================================================

model Event {
  id          String    @id @default(uuid())
  title       String
  description String?
  startDate   DateTime
  endDate     DateTime
  allDay      Boolean   @default(true)
  type        EventType
  color       String?   // hex color for calendar display
  targetId    String?   // Classroom ID or null for school-wide
  creatorId   String
  creator     User      @relation("EventCreator", fields: [creatorId], references: [id])
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([startDate])
  @@index([endDate])
  @@index([type])
  @@index([creatorId])
}

enum EventType {
  HOLIDAY     // วันหยุด
  EXAM        // สอบ
  ACTIVITY    // กิจกรรม
  MEETING     // ประชุม
  DEADLINE    // กำหนดส่งงาน
  OTHER       // อื่นๆ
}

// ============================================================
// Leave Request
// ============================================================

model LeaveRequest {
  id          String      @id @default(uuid())
  studentId   String
  student     Student     @relation(fields: [studentId], references: [id], onDelete: Cascade)
  startDate   DateTime
  endDate     DateTime
  reason      String
  type        LeaveType
  status      LeaveStatus @default(PENDING)
  attachments String[]    @default([])
  reviewerId  String?     // Teacher who approved/rejected
  reviewer    User?       @relation("LeaveReviewer", fields: [reviewerId], references: [id])
  reviewNote  String?
  reviewedAt  DateTime?
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  @@index([studentId])
  @@index([status])
  @@index([startDate])
  @@index([studentId, status])
}

enum LeaveType {
  SICK        // ลาป่วย
  PERSONAL    // ลากิจ
  OTHER       // อื่นๆ
}

enum LeaveStatus {
  PENDING     // รอพิจารณา
  APPROVED    // อนุมัติ
  REJECTED    // ไม่อนุมัติ
}

// ============================================================
// Student Portfolio
// ============================================================

model PortfolioItem {
  id          String        @id @default(uuid())
  studentId   String
  student     Student       @relation(fields: [studentId], references: [id], onDelete: Cascade)
  title       String
  description String?
  category    PortfolioCategory
  fileUrl     String?       // รูปภาพหรือไฟล์แนบ
  link        String?       // ลิงก์ภายนอก
  date        DateTime?     // วันที่ได้รับ/ทำกิจกรรม
  isPublic    Boolean       @default(true)
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  @@index([studentId])
  @@index([category])
}

enum PortfolioCategory {
  AWARD         // รางวัล/เกียรติบัตร
  ACTIVITY      // กิจกรรม
  PROJECT       // โปรเจค/ผลงาน
  CERTIFICATE   // ใบประกาศ
  VOLUNTEER     // จิตอาสา
  OTHER         // อื่นๆ
}

// ============================================================
// QR Code Attendance
// ============================================================

model QRAttendanceSession {
  id          String    @id @default(uuid())
  classroomId String
  classroom   Classroom @relation(fields: [classroomId], references: [id], onDelete: Cascade)
  creatorId   String
  creator     User      @relation("QRSessionCreator", fields: [creatorId], references: [id])
  period      Int       // คาบเรียน 0-8
  code        String    @unique // รหัส QR 6 หลัก
  expiresAt   DateTime  // หมดอายุเมื่อไหร่
  isActive    Boolean   @default(true)
  date        DateTime  @default(now()) // วันที่เช็คชื่อ
  createdAt   DateTime  @default(now())

  @@index([code])
  @@index([classroomId])
  @@index([expiresAt])
}

// ============================================================
// Survey / แบบประเมิน
// ============================================================

model Survey {
  id          String           @id @default(uuid())
  title       String
  description String?
  creatorId   String
  creator     User             @relation("SurveyCreator", fields: [creatorId], references: [id])
  targetId    String?          // Classroom ID or null for school-wide
  isActive    Boolean          @default(true)
  isAnonymous Boolean          @default(false)
  startsAt    DateTime?        // เริ่มตอบได้เมื่อไหร่
  endsAt      DateTime?        // หมดเขตตอบเมื่อไหร่
  questions   SurveyQuestion[]
  responses   SurveyResponse[]
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt

  @@index([creatorId])
  @@index([isActive])
}

model SurveyQuestion {
  id        String             @id @default(uuid())
  surveyId  String
  survey    Survey             @relation(fields: [surveyId], references: [id], onDelete: Cascade)
  text      String
  type      SurveyQuestionType
  options   String[]           @default([]) // ตัวเลือก (สำหรับ CHOICE/RATING)
  required  Boolean            @default(true)
  order     Int                @default(0)
  createdAt DateTime           @default(now())

  @@index([surveyId])
}

model SurveyResponse {
  id        String   @id @default(uuid())
  surveyId  String
  survey    Survey   @relation(fields: [surveyId], references: [id], onDelete: Cascade)
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  answers   Json     // { questionId: answer } format
  createdAt DateTime @default(now())

  @@unique([surveyId, userId]) // ตอบได้ครั้งเดียว
  @@index([surveyId])
}

enum SurveyQuestionType {
  TEXT      // ข้อความอิสระ
  CHOICE    // เลือกตอบ
  RATING    // ให้คะแนน 1-5
  YESNO     // ใช่/ไม่ใช่
}
